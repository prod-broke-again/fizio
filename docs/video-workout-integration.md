# Интеграция видео в тренировки

## Обзор

Добавлена поддержка загрузки и отображения видео для упражнений в системе тренировок V2. Система поддерживает как загрузку локальных файлов, так и использование внешних URL.

## Функциональность

### 1. Загрузка видео файлов
- Поддержка форматов: MP4, AVI, MOV, WMV, WebM
- Максимальный размер: 100MB
- Хранение в директории: `storage/app/public/workout-videos/`

### 2. Загрузка превью изображений
- Поддержка форматов: JPEG, PNG, WebP
- Максимальный размер: 5MB
- Хранение в директории: `storage/app/public/workout-thumbnails/`

### 3. Внешние URL
- Поддержка YouTube, Vimeo, Dailymotion, Twitch
- Валидация URL превью изображений

## Изменения в базе данных

### Таблица `workout_exercises_v2`
Добавлены поля:
- `video_file` - путь к локальному видео файлу
- `thumbnail_file` - путь к локальному превью файлу

## API изменения

### WorkoutExerciseV2Resource
Обновлен формат ответа для включения структурированных данных о видео:

```json
{
  "video": {
    "url": "https://youtube.com/watch?v=...",
    "file": "http://domain.com/storage/workout-videos/video.mp4",
    "has_video": true
  },
  "thumbnail": {
    "url": "https://example.com/thumb.jpg",
    "file": "http://domain.com/storage/workout-thumbnails/thumb.jpg",
    "has_thumbnail": true
  }
}
```

## Админка (Filament)

### WorkoutExerciseV2Resource
- Добавлена секция "Видео" с полями для загрузки файлов
- Поддержка drag & drop загрузки
- Валидация типов и размеров файлов
- Предварительный просмотр изображений
- Альтернативные поля для URL

### Таблица упражнений
- Колонка статуса видео (файл/URL/нет)
- Иконки для быстрого определения типа
- Скрываемые колонки для превью

## Валидация

### WorkoutExerciseV2Request
- Валидация типов файлов
- Проверка размеров файлов
- Валидация URL видео и превью
- Уникальность slug

## Модель WorkoutExerciseV2

### Новые методы
- `hasVideo()` - проверка наличия видео
- `hasThumbnail()` - проверка наличия превью
- `getVideoUrl()` - получение URL видео (приоритет файлу)
- `getThumbnailUrl()` - получение URL превью (приоритет файлу)
- `getVideoType()` - тип видео (file/url/none)
- `getThumbnailType()` - тип превью (file/url/none)

## Тестирование

Создан полный набор тестов в `WorkoutExerciseV2VideoTest`:
- Создание упражнения с видео файлом
- Создание упражнения с URL видео
- Создание упражнения без видео
- Валидация файлов
- API ответы

## Использование

### В админке
1. Перейти в раздел "Тренировки V2" → "Упражнения"
2. Создать или редактировать упражнение
3. В секции "Видео" загрузить файлы или указать URL
4. Сохранить изменения

### В API
```php
// Получение упражнения с видео
$exercise = WorkoutExerciseV2::with('program')->find(1);
$videoUrl = $exercise->getVideoUrl();
$hasVideo = $exercise->hasVideo();
```

## Безопасность

- Валидация типов файлов
- Ограничение размеров файлов
- Проверка URL на поддерживаемые домены
- Защита от загрузки вредоносных файлов

## Производительность

- Ленивая загрузка видео данных
- Кеширование URL файлов
- Оптимизация запросов к базе данных
- Сжатие изображений превью
